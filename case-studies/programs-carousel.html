<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Case Study · Programs Carousel (Gutenberg, SSR) · Zach Turner</title>
    <meta name="description" content="Server‑rendered Programs Carousel block with geo context, taxonomy merging, clean integration hooks, and optional ad injection." />
    <meta name="color-scheme" content="light dark" />
    <meta name="theme-color" content="#0B0D10" media="(prefers-color-scheme: dark)">
    <meta name="theme-color" content="#F7FAFC" media="(prefers-color-scheme: light)">

    <!-- Prism.js theme (okaidia works well in dark mode but still readable in light) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- IMPORTANT: relative path from /case-studies/ -->
    <link rel="stylesheet" href="../assets/css/stylesheet.css" />

    <style>
      /* Page-specific layout only (everything else comes from your shared CSS) */
      .cs-hero h1 { margin: .35em 0; }
      .cs-meta { color: var(--muted); }
      .props-grid { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 10px; }
      @media (max-width: 860px){ .props-grid { grid-template-columns: 1fr; } }

      pre { background: var(--panel); padding: 12px; border-radius: var(--radius); overflow-x: auto; border: 1px solid var(--border); box-shadow: var(--shadow); }
      code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: .9rem; }
    </style>
  </head>
  <body>
    <header class="nav" role="banner">
      <div class="wrap nav-inner">
        <div class="brand"><span class="dot" aria-hidden="true"></span> Zach Turner</div>
        <nav class="nav-links" aria-label="Primary">
          <a href="../index.html#work">Work</a>
          <a href="../index.html#about">About</a>
          <a href="../index.html#contact">Contact</a>
          <a class="btn" href="../Zachary_Turner_Resume_2025_with_short_summary.pdf" target="_blank" rel="noopener">Resume</a>
        </nav>
      </div>
    </header>

    <main class="wrap" id="main-content">
      <section class="section cs-hero">
        <div class="kicker">Case Study</div>
        <h1>Programs Carousel · Gutenberg (SSR)</h1>
        <p class="cs-meta">WordPress · Gutenberg · Server‑Side Rendering · API Integration</p>
      </section>

      <section class="section">
        <h2>Problem</h2>
        <div class="card project-card">
          <p>
            Surface location‑relevant “programs” in a performant carousel that editors can drop anywhere.
            Requirements: geo‑aware results from a cookie, optional merge of page categories with editor‑selected
            categories, clean integration hooks for the data layer, and an optional ad slot without breaking layout.
          </p>
        </div>
      </section>

      <section class="section">
        <h2>Approach</h2>
        <div class="card project-card">
          <ul class="colored">
            <li><strong>SSR block</strong> for fast first paint and consistent escaping/sanitization</li>
            <li><strong>Geo context</strong> (lat/lon/postal code) read from a cookie and passed to the query</li>
            <li><strong>Taxonomy merge</strong>: combine page categories with block‑selected categories (optional)</li>
            <li><strong>Integration hooks</strong>: vendor‑neutral filters to fetch/augment query params</li>
            <li><strong>Composable inner blocks</strong>: inlined geolocation form + SSR program cards</li>
            <li><strong>Monetization</strong>: configurable ad injection at a specific index (stubbed vendor code)</li>
          </ul>
        </div>
      </section>

      <section class="section">
        <h2>Key Snippet (Render)</h2>
        <div class="card project-card">
          <p>
            The render callback below shows the core: cookie‑driven geo context, category merging, filter‑based
            data fetching, ad injection, and safe output. All integration points are neutral (no company branding).
          </p>
<pre><code class="language-php">
&lt;?php
/**
 * Programs Carousel (SSR, vendor‑neutral)
 */
$api_plugin_active = apply_filters( 'programs_carousel/is_api_available', true );

if ( $api_plugin_active ) {
    // 1) Geo context from cookie
    $cookie_key   = apply_filters( 'programs_carousel/location_cookie_key', 'location_data' );
    $rawCookie    = isset($_COOKIE[$cookie_key]) ? stripslashes($_COOKIE[$cookie_key]) : null;
    $locationData = $rawCookie ? json_decode($rawCookie, true) : null;

    $lat     = $locationData['latitude']  ?? '';
    $lon     = $locationData['longitude'] ?? '';
    $zipcode = $locationData['zipcode']   ?? '';

    // 2) Base query from block attrs
    $query_params = [
        'lat'                =&gt; $lat,
        'lon'                =&gt; $lon,
        'postal_code'        =&gt; $zipcode,
        'distance'           =&gt; isset($attributes['distance']) ? (int) $attributes['distance'] : 0,
        'include_affiliates' =&gt; ! empty($attributes['includeAffiliates']),
        'listing_type'       =&gt; isset($attributes['listingType']) ? sanitize_text_field($attributes['listingType']) : '',
        'max_price'          =&gt; isset($attributes['priceMax']) ? (float) $attributes['priceMax'] : null,
        'min_price'          =&gt; isset($attributes['priceMin']) ? (float) $attributes['priceMin'] : null,
        'per_page'           =&gt; 12,
    ];

    // 3) Merge page cats + selected cats (optional)
    $categoryIds = $attributes['selectedCategories'] ?? [];
    if ( ! empty( $categoryIds ) ) {
        if ( ! empty( $attributes['categoryParentPageInclude'] ) ) {
            global $post;
            $defaultIds  = array_map(fn($c) =&gt; $c-&gt;term_id, get_the_category($post-&gt;ID) ?: []);
            $categoryIds = array_unique(array_merge($defaultIds, $categoryIds));
            $excludePostId[] = $post-&gt;ID; // avoid showing current page
        }

        // 4) Let data layer augment query
        $query_params = apply_filters('programs_carousel/augment_query_with_categories', $query_params, $categoryIds);
    }

    // 5) Fetch programs via data layer
    $programs = apply_filters('programs_carousel/fetch_programs', $query_params);
} else {
    $programs = [];
}

// 6) Presentation
$columns         = ! empty($attributes['carouselDisplayCount']) ? (int) $attributes['carouselDisplayCount'] : 3;
$colorBackground = ! empty($attributes['colorBackground']) ? sanitize_html_class($attributes['colorBackground']) : '';
$paddingRemove   = ! empty($attributes['paddingRemove'])   ? sanitize_html_class($attributes['paddingRemove'])   : '';

// 7) Optional ad
$adEnable = ! empty($attributes['adEnable']);
$adPos    = isset($attributes['adPosition']) ? (int) $attributes['adPosition'] : 0;
$adUnit   = isset($attributes['adUnit']) ? sanitize_text_field($attributes['adUnit']) : '';
$adDomId  = uniqid('program-carousel-ad-');
?&gt;

&lt;div &lt;?php echo get_block_wrapper_attributes(); ?&gt;&gt;
  &lt;div class="program-carousel container &lt;?php echo esc_attr(trim($colorBackground.' '.$paddingRemove)); ?&gt;"
       data-distance="&lt;?php echo esc_attr($attributes['distance'] ?? ''); ?&gt;"
       data-include-affiliates="&lt;?php echo esc_attr(!empty($attributes['includeAffiliates']) ? 'true' : 'false'); ?&gt;"
       data-listing-type="&lt;?php echo esc_attr($attributes['listingType'] ?? ''); ?&gt;"
       data-max-price="&lt;?php echo esc_attr($attributes['priceMax'] ?? ''); ?&gt;"
       data-min-price="&lt;?php echo esc_attr($attributes['priceMin'] ?? ''); ?&gt;"
       data-block-type="program-carousel"&gt;

    &lt;div class="program-carousel__body text-content"&gt;
      &lt;?php echo wp_kses_post($attributes['body'] ?? ''); ?&gt;
    &lt;/div&gt;

    &lt;?php
      // Inner block: Geolocation form (SSR)
      echo render_block([ 'blockName' =&gt; 'app/geolocation-form' ]);
    ?&gt;

    &lt;div class="program-carousel__grid" data-columns="&lt;?php echo esc_attr($columns); ?&gt;"&gt;
      &lt;?php
      if ( ! empty($programs['metadata']['pagination']['total']) ) {
        $shown = 0; $max = 12;

        foreach ( (array) ($programs['result'] ?? []) as $i =&gt; $program ) {
          // Ad injection at specific index
          if ( $adEnable &amp;&amp; ($i + 1) === $adPos ) {
            ?&gt;
            &lt;div class="program-carousel__ad"&gt;
              &lt;div id="&lt;?php echo esc_attr($adDomId); ?&gt;" class="ad-slot"&gt;
                &lt;script type="text/plain" class="consent-ad-category"&gt;
                  // Hook up your ad stack here, e.g. window.initAdSlot('&lt;?php echo esc_js($adDomId); ?&gt;', { unit: '&lt;?php echo esc_js($adUnit); ?&gt;' });
                &lt;/script&gt;
              &lt;/div&gt;
            &lt;/div&gt;
            &lt;?php
            if (++$shown &gt;= $max) break;
          }

          // Program card as SSR inner block
          echo render_block([
            'blockName' =&gt; 'app/program-card',
            'attrs'     =&gt; [ 'program' =&gt; $program ],
          ]);

          if (++$shown &gt;= $max) break;
        }
      }
      ?&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre>
        </div>
      </section>

      <section class="section">
        <h2>Block API & Integration Points</h2>
        <div class="card project-card">
          <div class="props-grid">
            <div><strong>Hook</strong><br><code>programs_carousel/is_api_available</code></div>
            <div><strong>Purpose</strong><br>Feature‑flag the data layer per environment.</div>

            <div><strong>Hook</strong><br><code>programs_carousel/location_cookie_key</code></div>
            <div><strong>Purpose</strong><br>Swap the cookie key (e.g., <code>location_data</code>).</div>

            <div><strong>Hook</strong><br><code>programs_carousel/augment_query_with_categories</code></div>
            <div><strong>Purpose</strong><br>Translate category IDs into API params (taxonomy mapping).</div>

            <div><strong>Hook</strong><br><code>programs_carousel/fetch_programs</code></div>
            <div><strong>Purpose</strong><br>Fetch results. Expected shape: <code>{ metadata.pagination.total, result[] }</code>.</div>
          </div>
        </div>
      </section>

      <section class="section" aria-labelledby="results-heading">
        <h2 id="results-heading">Results</h2>
        <div class="card project-card">
          <ul class="colored">
            <li>Geo‑aware results with SSR performance and safe output</li>
            <li>Editor‑friendly: reusable inner blocks and simple attributes</li>
            <li>Clean decoupling via filters: portable across vendors/environments</li>
            <li>Optional monetization without layout regressions</li>
          </ul>
        </div>
      </section>

      <section class="section">
        <h2>Recording & Links</h2>
        <div class="card project-card">
          <p>
            <a class="btn" href="#">Watch 2‑min overview</a>
            <a class="btn" href="#">View repo / gist</a>
          </p>
        </div>
      </section>
    </main>

    <footer class="wrap">
      <small>© <span id="y"></span> Zach Turner · Built with HTML/CSS on GitHub Pages</small>
    </footer>
    <script>document.getElementById('y').textContent = new Date().getFullYear();</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup-templating.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-php.min.js"></script>
  </body>
</html>
