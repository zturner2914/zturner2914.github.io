<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Program Aggregator Block · Gutenberg (SSR)</title>
    <meta name="description" content="Server-rendered Program Aggregator block with geo context, taxonomy merging, SEO-first rendering, scalable content queries, and optional ad injection." />
    <meta name="color-scheme" content="light dark" />
    <meta name="theme-color" content="#0B0D10" media="(prefers-color-scheme: dark)">
    <meta name="theme-color" content="#F7FAFC" media="(prefers-color-scheme: light)">

    <!-- Prism.js theme (okaidia works well in dark mode but still readable in light) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- IMPORTANT: relative path from /case-studies/ -->
    <link rel="stylesheet" href="../assets/css/stylesheet.css" />

    <style>
      /* Page-specific layout only (everything else comes from your shared CSS) */
      .cs-hero h1 { margin: .35em 0; }
      .cs-meta { color: var(--muted); }
      .props-grid { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 10px; }
      @media (max-width: 860px){ .props-grid { grid-template-columns: 1fr; } }

      pre { background: var(--panel); padding: 12px; border-radius: var(--radius); overflow-x: auto; border: 1px solid var(--border); box-shadow: var(--shadow); }
      code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: .9rem; }
    </style>
  </head>
  <body>
    <header class="nav" role="banner">
      <div class="wrap nav-inner">
        <div class="brand"><span class="dot" aria-hidden="true"></span> Zach Turner</div>
        <nav class="nav-links" aria-label="Primary">
          <a href="../index.html#work">Work</a>
          <a href="../index.html#about">About</a>
          <a href="../index.html#contact">Contact</a>
          <!-- <a class="btn" href="../Zachary_Turner_Resume_2025_with_short_summary.pdf" target="_blank" rel="noopener">Resume</a> -->
        </nav>
      </div>
    </header>

    <main class="wrap" id="main-content">
      <section class="section cs-hero">
        <div class="kicker">Case Study</div>
        <h1>Program Aggregator Block · Gutenberg</h1>
        <p class="cs-meta">WordPress · Gutenberg · Server‑Side Rendering · API Integration</p>
      </section>

      <section class="section">
        <h2>Problem</h2>
        <div class="card project-card">
          <p>
          Build a scalable, SEO-first program aggregation system that dynamically surfaces location-relevant content while remaining fully crawlable and performant. 
          The component needed to support geo-aware filtering, taxonomy merging, monetization hooks, and reusable inner blocks, all without sacrificing server-side rendering or clean markup.
          </p>
        </div>
      </section>

   <section class="section">
      <h2>SEO & Performance Principles</h2>
      <div class="card project-card">
        <ul class="colored">
          <li><strong>Server-Side Rendering:</strong> All program content is rendered server-side to ensure full crawlability and indexability.</li>
          <li><strong>Semantic Markup:</strong> Proper heading hierarchy, structured containers, and clean HTML output.</li>
          <li><strong>Internal Linking Strategy:</strong> Program cards link into taxonomy-driven landing pages to strengthen topical clusters.</li>
          <li><strong>Query Efficiency:</strong> Controlled result limits and filter-based query augmentation to reduce unnecessary load.</li>
          <li><strong>Core Web Vitals Awareness:</strong> Minimized client-side JS, controlled asset loading, and optional ad injection without layout shift.</li>
        </ul>
      </div>
    </section>

<section class="section">
  <h2>Block Definition (block.json excerpt)</h2>
  <div class="card project-card">
    <p>
      The Program Aggregator block is defined using the modern <code>block.json</code> API (apiVersion 3) 
      and leverages server-side rendering via <code>render.php</code>. Attributes support SEO-focused 
      aggregation logic, geo-aware filtering, monetization controls, and editor-driven configuration.
    </p>

<pre><code class="language-json">
{
  "apiVersion": 3,
  "name": "cet/programs-and-articles",
  "title": "Program Aggregator",
  "category": "widgets",
  "supports": {
    "html": false
  },
  "attributes": {
    "selectedCategories": {
      "type": "array",
      "items": { "type": "integer" },
      "default": []
    },
    "pageAggregationMatchLogic": {
      "type": "string",
      "default": "any"
    },
    "distance": {
      "type": "string",
      "default": ""
    },
    "includeAffiliates": {
      "type": "boolean",
      "default": false
    },
    "maxItems": {
      "type": "number",
      "default": 4
    },
    "priceMin": {
      "type": "number",
      "default": 0
    },
    "priceMax": {
      "type": "number",
      "default": 0
    },
    "adEnableLarge": {
      "type": "boolean",
      "default": false
    },
    "adPositionLarge": {
      "type": "integer",
      "default": 1
    }
  },
  "textdomain": "programs-and-articles",
  "editorScript": "file:./index.js",
  "editorStyle": "file:./index.css",
  "style": "file:./style-index.css",
  "render": "file:./render.php",
  "viewScript": "file:./view.js"
}
</code></pre>

  </div>
</section>

<section class="section">
  <h2>Editor Experience & Dynamic Controls</h2>
  <div class="card project-card">
    <p>
      The block dynamically fetches taxonomy data from a custom REST endpoint 
      and builds lookup tables for ID ↔ label mapping, allowing editors to 
      aggregate content without manual ID entry.
    </p>

<pre><code class="language-js">
useEffect(() => {
  apiFetch({ path: '/cet-aggregation/v1/categories' })
    .then(data => {
      setCategories(data.categories);
      setLookupTables(data.lookupTables);
    })
    .catch(error => {
      console.error('Error fetching categories:', error);
      setError('Failed to fetch categories');
    });
}, []);
</code></pre>

  </div>


  <div class="card project-card">
<pre><code class="language-js">
&lt;FormTokenField
  label="Select Categories to Aggregate"
  value={attributes.selectedCategories
    .map(id =&gt; lookupTables.idToLabel[id])
    .filter(Boolean)}
  suggestions={categories.map(category =&gt; category.hierarchy ?? '')}
  onChange={tokens =&gt; {
    const newSelectedCategories = tokens
      .map(token =&gt; lookupTables.labelToId[token])
      .filter(id =&gt; id != null);

    setAttributes({ selectedCategories: newSelectedCategories });
  }}
/&gt;
</code></pre>



  </div>
</section>


<!-- ========================= -->
<!-- Server-Side Rendering (render.php excerpts) -->
<!-- Paste this section into your case study page -->
<!-- ========================= -->

<section class="section" id="render-php">
  <h2>Server-Side Aggregation (render.php)</h2>

  <div class="card project-card">
    <p>
      The block is rendered server-side to keep aggregated content crawlable and consistent.
      The render layer also scopes attributes by concern (program grid vs. article list),
      merges taxonomy from the parent page when enabled, and composes nested SSR blocks for
      reusable layouts.
    </p>

    <h3>1) Attribute scoping by concern</h3>
    <p class="cs-meta">
      Only the attributes needed by each sub-component are passed through, keeping the interface clean
      and limiting unintended coupling.
    </p>
<pre><code class="language-php">
$program_grid_attributes = array_intersect_key(
    $attributes,
    array_flip([
        'selectedCategories',
        'categoryParentPageInclude',
        'adPositionLarge',
        'adUnitLarge',
        'adEnableLarge',
        'distance',
        'includeAffiliates',
        'listingType',
        'maxItems',
        'priceMax',
        'priceMin',
        'programGridTitle',
    ])
);

$article_list_attributes = array_intersect_key(
    $attributes,
    array_flip([
        'adEnableSmall',
        'adPositionSmall',
        'adUnitSmall',
        'selectedCategories',
        'categoryParentPageInclude',
        'pageAggregationMatchLogic',
        'pageRandomize',
        'relatedContentUrl',
        'relatedContentTitle',
        'articleListTitle',
        'pageDisplayType',
    ])
);
</code></pre>

    <h3>2) Taxonomy merge (page categories + editor-selected categories)</h3>
    <p class="cs-meta">
      When enabled, the block can incorporate categories from the parent page and merge them with the
      block’s selected categories to create scalable, context-aware aggregation.
    </p>
<pre><code class="language-php">
$categoryIdsFromBlock = $attributes['selectedCategories'] ?? [];

if ( ! empty( $attributes['categoryParentPageInclude'] ) ) {
    global $post;

    $defaultCategories  = get_the_category( $post->ID );
    $defaultCategoryIds = array_map(
        fn( $cat ) =&gt; $cat-&gt;term_id,
        $defaultCategories ?: []
    );

    $categoryIds = array_unique(
        array_merge( $defaultCategoryIds, $categoryIdsFromBlock )
    );
} else {
    $categoryIds = $categoryIdsFromBlock;
}
</code></pre>

    <h3>3) Nested SSR block composition</h3>
    <p class="cs-meta">
      The top-level aggregator composes sub-blocks (program grid + article list) and passes only the
      relevant attributes to each one.
    </p>
<pre><code class="language-php">
$program_grid_block = render_block([
    'blockName' =&gt; 'cet/program-grid',
    'attrs'     =&gt; $program_grid_attributes,
]);

echo $program_grid_block;

$article_list_block = render_block([
    'blockName' =&gt; 'cet/article-list',
    'attrs'     =&gt; $article_list_attributes,
]);

echo $article_list_block;
</code></pre>

  </div>
</section>


<section class="section" id="program-grid-ssr">
  <h2>Program Grid · Dynamic Query & SEO Routing</h2>

  <div class="card project-card">
    <p>
      The Program Grid sub-block builds dynamic query parameters based on geo context,
      taxonomy selections, and pricing filters. It also constructs a canonical
      “View More” URL that preserves structured filtering for search engine crawlability.
    </p>

    <h3>1) Geo-aware query construction</h3>
<pre><code class="language-php">
$locationData = isset($_COOKIE['SESSlocationdata'])
    ? json_decode(stripslashes($_COOKIE['SESSlocationdata']), true)
    : null;

$lat     = $locationData['latitude']  ?? '';
$lon     = $locationData['longitude'] ?? '';
$zipcode = $locationData['zipcode']   ?? '';

$query_params = [
    'lat'               =&gt; $lat,
    'lon'               =&gt; $lon,
    'code'              =&gt; $zipcode,
    'distance'          =&gt; $attributes['distance'],
    'includeAffiliates' =&gt; $attributes['includeAffiliates'],
    'max_price'         =&gt; $attributes['priceMax'],
    'min_price'         =&gt; $attributes['priceMin'],
    'per_page'          =&gt; $maxItems,
];
</code></pre>

    <h3>2) Taxonomy → structured sport keys</h3>
<pre><code class="language-php">
foreach ($categoryIds as $categoryId) {
    $category = get_category($categoryId);
    if (!$category) continue;

    $sport_key = get_term_meta(
        $category-&gt;term_id,
        'portal_sport_key_id',
        true
    );

    if (!empty($sport_key) &amp;&amp; !in_array($sport_key, $sport_keys, true)) {
        $sport_keys[] = $sport_key;
    }
}

$sport_keys_imploded =
    'sport_keys[]=' . implode('&amp;sport_keys[]=', array_map('rawurlencode', $sport_keys));
</code></pre>

    <h3>3) Canonical View More URL construction</h3>
<pre><code class="language-php">
$qs = [];

if ($lat !== '' &amp;&amp; $lon !== '') {
    $qs[] = 'latitude='  . rawurlencode((string) $lat);
    $qs[] = 'longitude=' . rawurlencode((string) $lon);
}

if ($sport_keys_imploded !== '') {
    $qs[] = $sport_keys_imploded;
}

$view_more_href =
    'https://www.sportsengine.com/search/listings'
    . (!empty($qs) ? '?' . implode('&amp;', $qs) : '');
</code></pre>

  </div>

  <div class="card project-card">
  <pre><code class="language-php">
if ($adEnableLarge && (int) $adPositionLarge === (int) ($index + 1)) {
    echo '&lt;div class="ad-card"&gt;';
    echo '&lt;div id="' . esc_attr($adUniqueId) . '" class="block-gam"&gt;&lt;/div&gt;';
    echo '&lt;/div&gt;';
}
</code></pre>
</div>

</section>

<section class="section" aria-labelledby="results-heading">
  <h2 id="results-heading">Results</h2>
  <div class="card project-card">
    <ul class="colored">
      <li><strong>SEO-first aggregation:</strong> Fully server-rendered program and article content to ensure crawlability, clean markup, and structured internal linking.</li>
      <li><strong>Scalable content hubs:</strong> Enabled editors to dynamically generate location-aware and taxonomy-driven landing pages without manual curation.</li>
      <li><strong>Composable architecture:</strong> Decoupled data fetching, aggregation logic, and presentation layers for portability across multisite environments.</li>
      <li><strong>Monetization without compromise:</strong> Configurable ad injection that preserved layout stability and avoided negative impact to performance metrics.</li>
    </ul>
  </div>
</section>

    <footer class="wrap">
      <small>© <span id="y"></span> Zach Turner</small>
    </footer>
    <script>document.getElementById('y').textContent = new Date().getFullYear();</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup-templating.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-php.min.js"></script>
  </body>
</html>
